name: Build Aria2 Windows (Docker Logic / Unlimited)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build-cross-compile:
    runs-on: ubuntu-latest
    env:
      HOST: x86_64-w64-mingw32
      
    steps:
    - name: Checkout Aria2 Source
      uses: actions/checkout@v4
      with:
        repository: aria2/aria2
        ref: master

    # ==========================================
    # 1. 安装基础编译工具
    # ==========================================
    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          make binutils autoconf automake autotools-dev libtool \
          patch ca-certificates pkg-config git curl dpkg-dev \
          gcc-mingw-w64 g++-mingw-w64 autopoint gettext libcppunit-dev \
          libxml2-dev libgcrypt20-dev lzip python3-docutils

    # ==========================================
    # 2. 准备目录权限
    # ==========================================
    - name: Prepare Target Directory Permissions
      run: |
        sudo mkdir -p /usr/local/$HOST
        sudo chown -R $(whoami) /usr/local/$HOST

    # ==========================================
    # 3. 编译依赖库 (带重试机制)
    # ==========================================
    - name: Compile Dependencies
      run: |
        mkdir -p deps
        cd deps
        CURL_ARGS="-f -L -O --retry 5 --retry-delay 10 --connect-timeout 30"
        
        # 1. GMP
        echo "Downloading & Compiling GMP..."
        curl $CURL_ARGS https://ftp.gnu.org/gnu/gmp/gmp-6.3.0.tar.xz
        tar xf gmp-6.3.0.tar.xz
        cd gmp-6.3.0
        ./configure --disable-shared --enable-static --prefix=/usr/local/$HOST --host=$HOST --disable-cxx --enable-fat CFLAGS="-mtune=generic -O2 -g0"
        make -j$(nproc) install
        cd ..

        # 2. Expat
        echo "Downloading & Compiling Expat..."
        curl $CURL_ARGS https://github.com/libexpat/libexpat/releases/download/R_2_5_0/expat-2.5.0.tar.bz2
        tar xf expat-2.5.0.tar.bz2
        cd expat-2.5.0
        ./configure --disable-shared --enable-static --prefix=/usr/local/$HOST --host=$HOST --build=`dpkg-architecture -qDEB_BUILD_GNU_TYPE`
        make -j$(nproc) install
        cd ..

        # 3. Sqlite3
        echo "Downloading & Compiling Sqlite3..."
        curl $CURL_ARGS https://www.sqlite.org/2023/sqlite-autoconf-3430100.tar.gz
        tar xf sqlite-autoconf-3430100.tar.gz
        cd sqlite-autoconf-3430100
        ./configure --disable-shared --enable-static --prefix=/usr/local/$HOST --host=$HOST --build=`dpkg-architecture -qDEB_BUILD_GNU_TYPE`
        make -j$(nproc) install
        cd ..

        # 4. Zlib
        echo "Downloading & Compiling Zlib..."
        curl $CURL_ARGS https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
        tar xf zlib-1.3.1.tar.gz
        cd zlib-1.3.1
        CC=$HOST-gcc AR=$HOST-ar LD=$HOST-ld RANLIB=$HOST-ranlib STRIP=$HOST-strip ./configure --prefix=/usr/local/$HOST --libdir=/usr/local/$HOST/lib --includedir=/usr/local/$HOST/include --static
        make -j$(nproc) install
        cd ..

        # 5. C-Ares
        echo "Downloading & Compiling C-Ares..."
        curl $CURL_ARGS https://github.com/c-ares/c-ares/releases/download/cares-1_19_1/c-ares-1.19.1.tar.gz
        tar xf c-ares-1.19.1.tar.gz
        cd c-ares-1.19.1
        ./configure --disable-shared --enable-static --without-random --prefix=/usr/local/$HOST --host=$HOST --build=`dpkg-architecture -qDEB_BUILD_GNU_TYPE` LIBS="-lws2_32"
        make -j$(nproc) install
        cd ..

        # 6. LibSSH2
        echo "Downloading & Compiling LibSSH2..."
        curl $CURL_ARGS https://libssh2.org/download/libssh2-1.11.0.tar.bz2
        tar xf libssh2-1.11.0.tar.bz2
        cd libssh2-1.11.0
        ./configure --disable-shared --enable-static --prefix=/usr/local/$HOST --host=$HOST --build=`dpkg-architecture -qDEB_BUILD_GNU_TYPE` LIBS="-lws2_32"
        make -j$(nproc) install
        cd ..

    # ==========================================
    # 4. 修改源代码 (解除限制)
    # ==========================================
    - name: Patch Aria2 Source
      run: |
        echo "正在修改 OptionHandlerFactory.cc ..."
        sed -i 's/"1", 1, 16,/"128", 1, -1,/g' src/OptionHandlerFactory.cc
        sed -i 's/"s", 1, 16,/"s", 1, 128,/g' src/OptionHandlerFactory.cc
        sed -i 's/"x", 1, 16,/"x", 1, 128,/g' src/OptionHandlerFactory.cc
        sed -i 's/"j", 1, 16,/"j", 1, 128,/g' src/OptionHandlerFactory.cc
        sed -i 's/"20M", 1_m, 1_g/"1M", 1_k, 1_g/g' src/OptionHandlerFactory.cc
        sed -i 's/"5", 1, -1,/"32", 1, -1,/g' src/OptionHandlerFactory.cc

    # ==========================================
    # 5. 编译 Aria2 (关键修正: 禁用 Libxml2, 强制链接路径)
    # ==========================================
    - name: Configure & Compile Aria2
      run: |
        export PKG_CONFIG_PATH="/usr/local/$HOST/lib/pkgconfig"
        
        autoreconf -fi
        
        # [FIX] 1. --without-libxml2: 防止引用系统头文件导致 iconv 错误
        # [FIX] 2. --with-libexpat: 强制使用我们编译的 Expat
        # [FIX] 3. LDFLAGS/CPPFLAGS: 显式指定路径，确保 configure 能检测到 GMP 等库
        
        ./configure \
            --host=$HOST \
            --prefix=/usr/local/$HOST \
            --disable-nls \
            --enable-static \
            --disable-shared \
            --without-libxml2 \
            --with-libexpat \
            --with-libgmp \
            --with-libssh2 \
            --with-sqlite3 \
            --with-libcares \
            --with-ca-bundle='/etc/ssl/certs/ca-certificates.crt' \
            ARIA2_STATIC=yes \
            CPPFLAGS="-I/usr/local/$HOST/include" \
            LDFLAGS="-L/usr/local/$HOST/lib -static -s" \
            LIBS="-lws2_32"
            
        make -j$(nproc)
        
        $HOST-strip src/aria2c.exe
        ls -lh src/aria2c.exe

    # ==========================================
    # 6. 上传成品
    # ==========================================
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aria2c-windows-unlimited
        path: src/aria2c.exe
