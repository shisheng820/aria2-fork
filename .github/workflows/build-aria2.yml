name: Build Aria2 with Unlimited Connections

on:
  workflow_dispatch: # 允许手动点击按钮触发构建
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: aria2/aria2
        ref: master

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxml2-dev libcppunit-dev autoconf automake autotools-dev autopoint libtool pkg-config libsqlite3-dev libssh2-1-dev libc-ares-dev

    - name: Apply Patches (Unlock Limits)
      run: |
        echo "Applying patches to OptionHandlerFactory.cc..."
        
        # 1. 解除最大连接数和分片数限制 (16 -> 65535)
        # 解释：定位所有将范围设为 1~16 的整数选项，修改为 1~65535
        sed -i 's/1, 16, /1, 65535, /g' src/OptionHandlerFactory.cc
        
        # 2. 解除最小分片大小限制 (1MB -> 1KB)
        # 解释：定位 1_m (1MB) 的下限，修改为 1_k (1KB)
        sed -i 's/1_m, 1_g, /1_k, 1_g, /g' src/OptionHandlerFactory.cc
        
        # 验证修改是否成功 (打印相关行)
        echo "--- Verification ---"
        grep -n "65535" src/OptionHandlerFactory.cc
        grep -n "1_k" src/OptionHandlerFactory.cc

    - name: Configure
      run: |
        autoreconf -i
        # 这里使用静态链接配置，生成的二进制文件迁移性更好
        ./configure --enable-static --disable-shared --with-libssh2 --with-ca-bundle='/etc/ssl/certs/ca-certificates.crt' ARIA2_STATIC=yes

    - name: Compile
      run: make -j$(nproc)

    - name: Strip Binary
      run: strip src/aria2c

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aria2c-unlimited-linux-amd64
        path: src/aria2c
