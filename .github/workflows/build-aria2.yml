name: Build Aria2 (Linux & Windows)

on:
  workflow_dispatch: # 手动触发
  push:
    branches: [ master ]

jobs:
  # ==================================================
  # 任务 1: 编译 Linux 版本 (使用 Native 环境 + 补全依赖)
  # ==================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: aria2/aria2
        ref: master

    - name: Install Dependencies (Linux)
      # 这里补全了你之前报错缺失的 liblzma, libgpg-error, libgcrypt, libcares 等
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxml2-dev libcppunit-dev autoconf automake autotools-dev autopoint libtool pkg-config \
          libsqlite3-dev libssh2-1-dev libc-ares-dev \
          liblzma-dev libgpg-error-dev libgcrypt20-dev libssl-dev zlib1g-dev

    - name: Apply Patches (Unlock Limits)
      run: |
        echo "Applying patches..."
        # 解除连接数限制 16 -> 65535
        sed -i 's/1, 16, /1, 65535, /g' src/OptionHandlerFactory.cc
        # 解除最小分片 1MB -> 1KB
        sed -i 's/1_m, 1_g, /1_k, 1_g, /g' src/OptionHandlerFactory.cc

    - name: Configure & Compile (Linux)
      run: |
        autoreconf -i
        # 静态链接，方便在不同 Linux 发行版运行
        ./configure --enable-static --disable-shared --with-libssh2 --with-ca-bundle='/etc/ssl/certs/ca-certificates.crt' ARIA2_STATIC=yes
        make -j$(nproc)
        strip src/aria2c

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aria2c-linux
        path: src/aria2c

  # ==================================================
  # 任务 2: 编译 Windows 版本 (使用 Docker 容器)
  # ==================================================
  build-windows:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: aria2/aria2
        ref: master

    - name: Apply Patches (Unlock Limits)
      # Windows 版同样需要打补丁
      run: |
        echo "Applying patches..."
        sed -i 's/1, 16, /1, 65535, /g' src/OptionHandlerFactory.cc
        sed -i 's/1_m, 1_g, /1_k, 1_g, /g' src/OptionHandlerFactory.cc

    - name: Build Docker Image
      # 对应教程中的：docker build -t aria2-mingw -f ./Dockerfile.mingw ./
      run: docker build -t aria2-mingw -f Dockerfile.mingw .

    - name: Compile in Docker
      # 对应教程中的运行容器命令。
      # 我们把所有命令串联起来，在容器内一次性执行完毕
      run: |
        docker run --rm -v $(pwd):/aria2 aria2-mingw /bin/sh -c "
          cd /aria2 && \
          autoreconf -i && \
          ./mingw-config && \
          make -j\$(nproc) && \
          i686-w64-mingw32-strip src/aria2c.exe
        "

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aria2c-windows
        path: src/aria2c.exe
