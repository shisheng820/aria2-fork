name: Build Aria2 (Name Fix)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  # ==========================================
  # 任务 1: Linux 编译 (保持不变)
  # ==========================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: aria2/aria2
        ref: master

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libxml2-dev libcppunit-dev autoconf automake \
          autotools-dev autopoint libtool pkg-config libsqlite3-dev \
          libssh2-1-dev libc-ares-dev liblzma-dev libgpg-error-dev \
          libgcrypt20-dev libssl-dev zlib1g-dev

    - name: Apply Patches
      run: |
        sed -i 's/1, 16, /1, 65535, /g' src/OptionHandlerFactory.cc
        sed -i 's/1_m, 1_g, /1_k, 1_g, /g' src/OptionHandlerFactory.cc

    - name: Configure & Compile
      run: |
        autoreconf -i
        STATIC_LIBS="$(pkg-config --static --libs libssh2 libcares libssl libcrypto zlib sqlite3 libxml-2.0)"
        ./configure \
          --enable-static \
          --disable-shared \
          --with-libssh2 \
          --with-ca-bundle='/etc/ssl/certs/ca-certificates.crt' \
          ARIA2_STATIC=yes \
          LIBS="$STATIC_LIBS"
        make -j$(nproc)
        strip src/aria2c

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aria2c-linux
        path: src/aria2c

  # ==========================================
  # 任务 2: Windows 编译 (修复语法错误与依赖)
  # ==========================================
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: aria2/aria2
        ref: master

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          base-devel
          git
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-libssh2
          mingw-w64-x86_64-c-ares
          mingw-w64-x86_64-expat
          mingw-w64-x86_64-sqlite3
          mingw-w64-x86_64-zlib
          mingw-w64-x86_64-openssl
          autotools
          automake-wrapper
          libtool
          gettext-devel
          # [FIX 1] 移除了 cppunit 依赖，避免触发导致语法错误的检测逻辑

    - name: Apply Patches & Fix Version
      run: |
        sed -i 's/1, 16, /1, 65535, /g' src/OptionHandlerFactory.cc
        sed -i 's/1_m, 1_g, /1_k, 1_g, /g' src/OptionHandlerFactory.cc
        
        # 修复 gettext 版本
        sed -i 's/AM_GNU_GETTEXT_VERSION(\[0.19\])/AM_GNU_GETTEXT_VERSION([0.22])/' configure.ac

        # [FIX 2] 强力修复：从 configure.ac 中删除对 deps/wslay 的引用
        # 即使使用了 --without-wslay，autoreconf 仍可能尝试配置子目录，导致失败。直接删掉这行最保险。
        sed -i '/AC_CONFIG_SUBDIRS(\[deps\/wslay\])/d' configure.ac

    - name: Configure & Compile
      run: |
        # [FIX 3] 使用 -fiv (force, install, verbose) 确保完全重新生成
        autoreconf -fiv
        
        # [FIX 4] 防止生成的文件包含 Windows CRLF 换行符导致 Shell 脚本语法错误
        sed -i 's/\r$//' configure

        # Windows 下使用 expat
        STATIC_LIBS="$(pkg-config --static --libs libssh2 libcares openssl sqlite3 zlib expat)"
        
        ./configure \
          --host=x86_64-w64-mingw32 \
          --enable-static \
          --disable-shared \
          --with-libssh2 \
          --with-sqlite3 \
          --without-gnutls \
          --with-openssl \
          --without-wslay \
          ARIA2_STATIC=yes \
          CFLAGS="-static -I/mingw64/include" \
          CXXFLAGS="-static -I/mingw64/include" \
          LDFLAGS="-static -all-static -L/mingw64/lib" \
          LIBS="$STATIC_LIBS"
          
        make -j$(nproc)
        strip src/aria2c.exe

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aria2c-windows
        path: src/aria2c.exe
